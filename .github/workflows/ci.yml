name: CI

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'

# Cancel previous runs for the same ref to save CI minutes.
concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  SCCACHE_CACHE_SIZE: "2G"
  CARGO_INCREMENTAL: "0"

jobs:
  read-rust-version:
    name: Read Rust version
    runs-on: ubuntu-latest
    outputs:
      rust-version: ${{ steps.read-version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Read Rust version from Cargo.toml
        id: read-version
        shell: bash
        run: |
          version=$(awk -F'"' '/^[[:space:]]*rust-version[[:space:]]*=/{print $2; exit}' Cargo.toml)
          if [ -z "$version" ]; then
            echo "Failed to read rust-version from Cargo.toml" >&2
            exit 1
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
  test:
    name: Test Suite (${{ matrix.os }}, rust=${{ needs.read-rust-version.outputs.rust-version }})
    runs-on: ${{ matrix.os }}
    needs: read-rust-version
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]

    steps:
      - name: Force LF in working tree (w/a for Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          clean: 'true'
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@9bc92bc5598b4f3bec5d910d352094982cb0c3b9 # stable
        with:
          toolchain: "${{ needs.read-rust-version.outputs.rust-version }}"
          components: rustfmt, clippy

      # Cache Cargo registry/git + target/ across platforms.
      - name: Cache Cargo/target
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          shared-key: ${{ matrix.os }}

      # Install sccache (cross-platform)
      - name: Install sccache
        uses: mozilla-actions/sccache-action@ee68efe471c107882388f2e629ccf265e279e9b6 # v0.0.5

      # Use a local disk dir for sccache and cache it with actions/cache (reliable).
      - name: Prepare sccache dir
        shell: bash
        run: |
          echo "SCCACHE_DIR=$RUNNER_TEMP/sccache" >> "$GITHUB_ENV"
          mkdir -p "$RUNNER_TEMP/sccache"

      - name: Cache sccache artifacts
        if: runner.os != 'macOS'
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ${{ runner.temp }}/sccache
          key: sccache-${{ runner.os }}-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            sccache-${{ runner.os }}-

      # Probe sccache; if startup fails, fall back to plain rustc (no hard CI failure).
      - name: Probe sccache & set RUSTC_WRAPPER
        shell: bash
        run: |
          if sccache --start-server >/dev/null 2>&1; then
            echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"
            echo "SCCACHE_OK=1" >> "$GITHUB_ENV"
          else
            echo "sccache failed, falling back to plain rustc"
            echo "RUSTC_WRAPPER=" >> "$GITHUB_ENV"
            echo "SCCACHE_OK=0" >> "$GITHUB_ENV"
          fi

      - name: Show rustc version
        run: rustc -Vv

      # Formatting check (fast fail for style issues)
      - name: cargo fmt (check)
        run: cargo fmt --all -- --check

      # Clippy lints across workspace and all targets; fail on warnings
      - name: cargo clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings -D clippy::perf

      # Unit tests
      - name: cargo test
        run: cargo test --workspace --no-fail-fast

      # Print sccache stats when active
      - name: sccache stats
        if: env.SCCACHE_OK == '1'
        run: sccache --show-stats

  security:
    name: Security (cargo-deny on Ubuntu)
    runs-on: ubuntu-latest
    needs: read-rust-version
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@9bc92bc5598b4f3bec5d910d352094982cb0c3b9 # stable
        with:
          toolchain: "${{ needs.read-rust-version.outputs.rust-version }}"

      - name: Cache Cargo/target
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8

      # Install tools via prebuilt binaries for speed.
      - name: Install cargo-deny
        uses: taiki-e/install-action@30eab0fabba9ea3f522099957e668b21876aa39e # v2.66.6
        with:
          tool: cargo-deny

      # Run deny checks but do not fail CI (as requested).
      - name: cargo deny check
        run: cargo deny check
        continue-on-error: true

  coverage:
    name: Code Coverage (cargo-llvm-cov)
    runs-on: ubuntu-latest
    needs: read-rust-version
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          submodules: recursive

      - name: Install Rust toolchain (with llvm-tools)
        uses: dtolnay/rust-toolchain@9bc92bc5598b4f3bec5d910d352094982cb0c3b9 # stable
        with:
          toolchain: "${{ needs.read-rust-version.outputs.rust-version }}"
          components: llvm-tools-preview

      - name: Cache Cargo/target
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8

      - name: Install sccache
        uses: mozilla-actions/sccache-action@ee68efe471c107882388f2e629ccf265e279e9b6 # v0.0.5

      - name: Prepare sccache dir
        shell: bash
        run: |
          echo "SCCACHE_DIR=$RUNNER_TEMP/sccache" >> "$GITHUB_ENV"
          mkdir -p "$RUNNER_TEMP/sccache"

      - name: Cache sccache artifacts
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ${{ runner.temp }}/sccache
          key: sccache-${{ runner.os }}-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            sccache-${{ runner.os }}-

      - name: Probe sccache & set RUSTC_WRAPPER
        shell: bash
        run: |
          if sccache --start-server >/dev/null 2>&1; then
            echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"
            echo "SCCACHE_OK=1" >> "$GITHUB_ENV"
          else
            echo "sccache failed, falling back to plain rustc"
            echo "RUSTC_WRAPPER=" >> "$GITHUB_ENV"
            echo "SCCACHE_OK=0" >> "$GITHUB_ENV"
          fi

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@30eab0fabba9ea3f522099957e668b21876aa39e # v2.66.6
        with:
          tool: cargo-llvm-cov

      # Generate lcov.info for upload.
      - name: Coverage (lcov)
        env:
          RUSTFLAGS: "-C debuginfo=0"
          CARGO_LLVM_COV_TARGET_DIR: llvm-cov-target
          CARGO_LLVM_COV_BUILD_DIR: llvm-cov-build
        run: |
          cargo llvm-cov clean --workspace
          cargo llvm-cov --workspace --lcov --output-path lcov.info

      # Upload to Codecov; do not fail CI if Codecov is down/misconfigured.
      - name: Upload to Codecov
        uses: codecov/codecov-action@0f8570b1a125f4937846a11fcfa3bcd548bd8c97 # v4.6.0
        with:
          files: lcov.info
          fail_ci_if_error: false
          # token: ${{ secrets.CODECOV_TOKEN }}  # Uncomment if required for private repos

  e2e:
    name: E2E Tests (gts-spec)
    runs-on: ubuntu-latest
    needs: read-rust-version
    env:
      PYTHONDONTWRITEBYTECODE: 1
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@9bc92bc5598b4f3bec5d910d352094982cb0c3b9 # stable
        with:
          toolchain: "${{ needs.read-rust-version.outputs.rust-version }}"

      - name: Cache Cargo/target
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8

      - name: Build release binary
        run: cargo build --workspace --release

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.11'

      - name: Install pytest and dependencies
        run: pip install pytest requests httprunner

      - name: Run e2e tests
        run: |
          # Start server in background with logs
          ./target/release/gts server --port 8000 > .server.log 2>&1 &
          SERVER_PID=$!
          echo "Started GTS server with PID $SERVER_PID"

          # Wait for server to be ready
          echo "Waiting for GTS server to start..."
          for i in $(seq 1 30); do
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "ERROR: Server process died unexpectedly"
              echo "=== Server logs ==="
              cat .server.log || true
              exit 1
            fi
            if curl -sf http://127.0.0.1:8000/entities > /dev/null 2>&1; then
              echo "GTS server is ready!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "ERROR: GTS server failed to start within 30 seconds"
              echo "=== Server logs ==="
              cat .server.log || true
              kill $SERVER_PID 2>/dev/null || true
              exit 1
            fi
            echo "Attempt $i/30: Server not ready yet, waiting..."
            sleep 1
          done

          # Run tests
          pytest -p no:cacheprovider ./.gts-spec/tests -v
          TEST_EXIT=$?

          # Stop server
          echo "Stopping GTS server..."
          kill $SERVER_PID 2>/dev/null || true
          wait $SERVER_PID 2>/dev/null || true

          exit $TEST_EXIT
